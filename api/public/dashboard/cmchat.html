<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <link rel="stylesheet" href="./styles.css"> <!-- Include your styles here -->
</head>
<body>
    <div class="chat-container">
        <h2 style="color: #FFF;">Chat</h2>
        <div id="messages" class="messages-box"></div>
        <form id="chatForm">
            <input type="text" id="messageInput" placeholder="Type your message..." required>
            <button type="submit">Send</button>
            <br>
            <div class="dashboard-link">
                <span style="color: white;">Back to <a style="color: #6e8efb;" href="/dashboard">Dashboard</a></span>
            </div>
        </form>
    </div>

    <script>
        // Fetch current user's profile information
        const username = localStorage.getItem('username') || 'Guest';
        const profilePfp = localStorage.getItem('profilePfp') || generatePfp(username);

        // Function to generate a PFP based on the username
        function generatePfp(username) {
            const firstLetter = username.charAt(0).toUpperCase();
            const canvas = document.createElement('canvas');
            const size = 30; // Adjust size to match your design
            canvas.width = size;
            canvas.height = size;

            const context = canvas.getContext('2d');
            context.fillStyle = getRandomColor();
            context.beginPath();
            context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            context.fill();
            context.fillStyle = '#FFFFFF';
            context.font = 'bold 20px Arial'; // Adjust font size
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(firstLetter, size / 2, size / 2);

            return canvas.toDataURL();
        }

        // Helper function to generate a random color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Function to fetch and display messages
        function fetchMessages() {
            fetch('/api/chat/messages') // Adjust to your server endpoint
                .then(response => response.json())
                .then(data => {
                    const messagesBox = document.getElementById('messages');
                    messagesBox.innerHTML = ''; // Clear existing messages
                    data.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message';
                        messageElement.innerHTML = `
                            <img src="${message.pfp}" alt="Profile Picture" class="message-pfp">
                            <strong>${message.username}:â €</strong> ${message.text}
                        `;
                        messagesBox.appendChild(messageElement);
                    });
                    messagesBox.scrollTop = messagesBox.scrollHeight; // Scroll to the bottom
                });
        }

        // Handle message sending
        document.getElementById('chatForm').addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value;

            fetch('/api/chat/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    pfp: profilePfp,
                    text: messageText
                })
            })
            .then(response => response.json())
            .then(data => {
                messageInput.value = ''; // Clear the input field
                fetchMessages(); // Refresh messages after sending
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        });

        // Fetch messages periodically
        setInterval(fetchMessages, 2000); // Fetch messages every 2 seconds
        fetchMessages(); // Initial fetch
    </script>

    <style>
        /* Add your CSS styles here */
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1c1c1c;
            margin: 0;
        }

        .dashboard-link {
            margin-top: 15px;
            text-align: center;
        }

        .chat-container {
            background: #2e2e2e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .messages-box {
            height: 300px;
            overflow-y: auto;
            background: #3a3a3a;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 10px;
            text-align: left;
        }

        .message {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: white;
        }

        .message-pfp {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        input[type="text"] {
            width: 80%;
            padding: 10px;
            margin-right: 5px;
            border-radius: 8px;
            border: none;
            background-color: #4a4a4a;
            color: #ddd;
            font-size: 16px;
        }

        button {
            padding: 10px 15px;
            background-color: #6e8efb;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #5a7ddb;
        }
    </style>
</body>
</html>
